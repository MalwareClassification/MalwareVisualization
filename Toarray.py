import pefile
import os
import numpy as np

class Toarray():
    def __init__(self, in_path, out_path, pic_size = 256, limit = True):
        self.in_path = in_path
        self.out_path = out_path
        self.size = pic_size
        self.limit = limit

    def transform(self):
        file_list = os.listdir(self.in_path)
        for files in file_list:
            current_path = os.path.join(self.in_path, files)
            pe = pefile.PE(current_path)
            with open(current_path , 'rb') as f:
                # .text 파일 찾기
                for section in pe.sections:
                    if b'.text' in section.Name:
                        place = section.PointerToRawData
                        length = section.SizeOfRawData
                        if length > 0:
                            f.seek(place-1)
                            #.text 데이터 읽기
                            data = f.read(length)
                            if self.limit == True:
                                # 원하는 크기의 배열 만들기
                                ndarray = np.zeros(self.size*self.size)
                                # 배열 .text데이터로 채우기 % 정규화
                                for i in range(len(data)):
                                    ndarray[i] = data[i]/255.0
                                    if i == self.size*self.size-1:
                                        break
                                # 배열 차원 조절
                                ndarray = np.reshape(ndarray, (self.size, self.size))
                            else:
                                if len(data)%self.size == 0:
                                    ndarray = np.zeros(self.size*(len(data)//self.size))
                                    for i in range(len(data)):
                                        ndarray[i] = data[i]/255.0
                                    ndarray = np.reshape(ndarray, (len(data)//self.size, self.size))
                                else:
                                    ndarray = np.zeros(self.size*(1 + len(data)//self.size))
                                    for i in range(len(data)):
                                        ndarray[i] = data[i]/255.0
                                    ndarray = np.reshape(ndarray, (1+len(data)//self.size, self.size))
                            # 배열 저장
                            np.save(os.path.join(self.out_path, files.split('.')[0]), ndarray)
"""
#from array to pic
import os
import numpy as np
from PIL import Image

class Topic():
    def __init__(self, in_path):
        self.in_path = in_path

    def transform(self):
        file_list = os.listdir(self.in_path)
        for files in file_list:
            array = np.load(os.path.join(self.in_path, files))
            array = array*255
            array = array. astype(np.uint8)
            im = Image.fromarray(array, 'L')
            im.save(files.split(".")[0] + ".png")
"""
