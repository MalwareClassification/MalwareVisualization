import csv
import pefile
import os
import numpy as np
def make_array(name, indata, size, ans):
    ndarray = np.zeros(size*size, np.uint8)
    i = 0
    for i in range(len(indata)):
        ndarray[i] = indata[i]
        if i == size*size-1:
            break
    np.reshape(ndarray, (size, size))
    if ans == '0':
        newpath = os.path.join(savepath0, name.strip('.vir') + '.npy')
        np.save(newpath, ndarray)
    else:
        newpath = os.path.join(savepath1, name.strip('.vir') + '.npy')
        np.save(newpath, ndarray)

def run(size):
    count = 0
    with open(anspath1 , 'r', encoding = 'utf-8') as f:
        rdr = csv.reader(f)
        for line in rdr:
            count += 1
            newdir = os.path.join(path1, line[0])
            pe = pefile.PE(newdir)
            with open (newdir, "rb") as f1:
                for section in pe.sections:
                    if b'.text' in section.Name:
                        place = section.PointerToRawData
                        length = section.SizeOfRawData
                        if length > 0:
                            f1.seek(place-1)
                            data = f1.read(length)
                            make_array(line[0], data, size, line[1])
            print(count,'of 15000 tasks done')
    with open(anspath2 , 'r', encoding = 'utf-8') as f:
        rdr = csv.reader(f)
        for line in rdr:
            count += 1
            newdir = os.path.join(path2, line[0])
            pe = pefile.PE(newdir)
            with open (newdir, "rb") as f1:
                for section in pe.sections:
                    if b'.text' in section.Name:
                        place = section.PointerToRawData
                        length = section.SizeOfRawData
                        if length > 0:
                            f1.seek(place-1)
                            data = f1.read(length)
                            make_array(line[0], data, size, line[1])
            print(count,'of 15000 tasks done')

if __name__ == "__main__":
    path1 = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'KISA-CISC2017-Malware-1st')
    path2 = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'KISA-CISC2017-Malware-2nd')
    savepath0 = os.path.join(os.path.dirname(os.path.abspath(__file__)), '0') #0과 1이라는 결과를 저장할 폴더를 미리 만들어놓은 상태입니다.
    savepath1 = os.path.join(os.path.dirname(os.path.abspath(__file__)), '1')
    anspath1 = os.path.join(os.path.dirname(os.path.abspath(__file__)), '1st_answer.csv')
    anspath2 = os.path.join(os.path.dirname(os.path.abspath(__file__)), '2nd_answer.csv')
    width = int(input("Enter the width of image you want: "))
    run(width)
